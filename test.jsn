/**!
 * @status stable
 * @version 1.0.0
 */

var fs = require('fs');
var path = require('path');
var assert = require('assert');

var snakeskin = require('./build/snakeskin');
var testFolder = path.resolve(__dirname, 'tests');

fs.readdirSync(testFolder).forEach((el) => {
	if (path.extname(el) === '.ss') {
		let src = path.join(testFolder, el);
		let txt = String(fs.readFileSync(src)).split('###');

		txt.forEach((el, i) => {
			txt[i] = el.trim();
		});

		let starts = txt[0].split(/[\n\r]+/);
		let results = txt[2].split('***');

		fs.writeFileSync(src + '.js', snakeskin.compile(txt[1], true));

		let tpl = require('./tests/' + el + '.js').liveInit('../build/snakeskin.live');

		starts.forEach((el, i) => {
			let params = el.split(' ; ');

			assert.equal(
				eval(
					'tpl.' + params[0] + '.apply(' +
						'tpl,' +
						'params.slice(1).map(function (el) {' +
							'try {' +
								'return Function("return " + el)();' +

							'} catch (ignore) {' +
								'return el;' +
							'}' +
						'})' +
					').trim()'
				),

				results[i].trim()
			);
		});
	}
});