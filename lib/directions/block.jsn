/*!
 * @status stable
 * @version 1.0.0
 */

/**
 * Директива block
 *
 * @param {string} command - текст команды
 *
 * @param {number} commandLength - длина команды
 * @param {!DirObj} dir - объект управления директивами
 *
 * @param {Object} adv - дополнительные параметры
 * @param {boolean} adv.dryRun - true, если холостая обработка
 * @param {!Object} adv.info - информация о шаблоне (название файлы, узла и т.д.)
 */
Snakeskin.Directions['block'] = function (command, commandLength, dir, adv) {
	if (!dir.structure.parent) {
		throw dir.error('Directive "block" can only be used within a "template" or "proto", ' +
			dir.genErrorAdvInfo(adv.info)
		);
	}

	var tplName = dir.tplName,
		parentName = dir.parentTplName;

	if (!adv.dryRun && ((parentName && !dir.hasPos('block') && !dir.hasPos('proto')) || !parentName)) {
		// Попытка декларировать блок несколько раз
		if (blockCache[tplName][command]) {
			throw dir.error(
				'Block "' + command + '" is already defined ' +
				'(command: {block ' + command + '}, template: "' + tplName + ', ' +
					dir.genErrorAdvInfo(adv.info) +
				'")!'
			);
		}

		blockCache[tplName][command] = {from: dir.i - dir.startI + 1};
	}

	dir.startDir('block', {
		name: command
	});
};

/**
 * Окончание block
 *
 * @param {string} command - текст команды
 *
 * @param {number} commandLength - длина команды
 * @param {!DirObj} dirObj - объект управления директивами
 *
 * @param {Object} adv - дополнительные параметры
 * @param {boolean} adv.dryRun - true, если холостая обработка
 */
Snakeskin.Directions['blockEnd'] = function (command, commandLength, dirObj, adv) {
	var lastBlock = dirObj.popPos('block');
	var block = blockCache[dirObj.tplName][lastBlock.name];

	if (!adv.dryRun &&
		((dirObj.parentTplName && !dirObj.hasPos('block') && !dirObj.hasPos('proto')) || !dirObj.parentTplName)
	) {
		block.to = dirObj.i - dirObj.startI - commandLength - 1;
		block.body = dirObj.source.substring(dirObj.startI).substring(block.from, block.to);
	}
};