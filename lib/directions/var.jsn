/**!
 * @status stable
 * @version 1.0.0
 */

DirObj.prototype.varCache = {
	init: function () {
		return {};
	}
};

DirObj.prototype.multiDeclVar = function (str, opt_end = true) {
	var isSys = 0,
		cache = '';

	var final = 'var ';

	var sysTable = {
		'(': true,
		'[': true,
		'{': true
	};

	var closeSysTable = {
		')': true,
		']': true,
		'}': true
	};

	var length = str.length;
	for (let i = 0; i < length; i++) {
		let el = str.charAt(i);

		if (sysTable[el]) {
			isSys++;

		} else if (closeSysTable[el]) {
			isSys--;
		}

		if ((el === ',' || i === length - 1) && !isSys) {
			if (i === length - 1) {
				cache += el;
			}

			let parts = cache.split('='),
				realVar = this.declVar(parts[0].trim());

			parts[0] = realVar + ' ';
			final += this.prepareOutput(parts.join('=') + ',', true);

			cache = '';
			continue;
		}

		cache += el;
	}

	if (isSys) {
		throw this.error('Invalid syntax');
	}

	return final.slice(0, -1) + (opt_end ? ';' : '');
};

Snakeskin.addDirective(
	'var',

	{
		placement: 'template',
		replacers: {
			':': (cmd) => cmd.replace(/^:/, 'var ')
		}
	},

	function (command) {
		if (!command) {
			throw this.error('Invalid syntax');
		}

		this.startInlineDir();
		if (this.isSimpleOutput()) {
			this.save(this.multiDeclVar(command));
		}
	}
);