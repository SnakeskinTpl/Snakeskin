/*!
 * @status stable
 * @version 1.0.0
 */

Snakeskin.addDirective(
	'const',

	null,

	function (command, commandLength) {
		if (!command) {
			throw this.error('Invalid syntax');
		}

		var tplName = this.tplName;
		var rgxp = this.scope.length ?
			/^[@#$a-z_][$\w\[\].'"\s]*([^=]?[+-/*><^]*)=[^=]?/i :
			/^[$a-z_][$\w\[\].'"\s]*([^=]?[+-/*><^]*)=[^=]?/i;

		var scan = rgxp.exec(command);

		// Инициализация переменных
		if (scan && !scan[1]) {
			let name = command.split('=')[0].trim(),
				mod = name.charAt(0);

			if (mod === '#' || mod === '@') {
				throw this.error('Can\'t declare constant "' + name + '" with the context modifier');
			}

			if (this.structure.parent) {
				this.startInlineDir('const');

				if (this.isAdvTest()) {
					// Попытка повторной инициализации константы
					if (constCache[tplName][name] || constICache[tplName][name]) {
						throw this.error('Constant "' + name + '" is already defined');
					}

					// Попытка инициализации константы, которая была объявлена как переменная
					if (this.varCache[name]) {
						throw this.error('Constant "' + name + '" is already defined as variable');
					}

					// Попытка инициализировать константу с зарезервированным именем
					if (sysConst[name]) {
						throw this.error('Can\'t declare constant "' + name + '", try another name');
					}

					// Кеширование
					constCache[tplName][name] = {
						from: this.i - this.startI - commandLength,
						to: this.i - this.startI
					};

					fromConstCache[tplName] = this.i - this.startI + 1;
				}

				if (this.isSimpleOutput()) {
					this.save(this.prepareOutput((!/[.\[]/.test(name) ? 'var ' : '') + command + ';', true));
				}

			} else {
				this.startInlineDir('globalVar');
				this.save('if (typeof Snakeskin !== \'undefined\') { Snakeskin.Vars.' +
					this.prepareOutput(command, true, null, true) +
				'; }');
			}

		// Вывод значения
		} else {
			if (!this.structure.parent) {
				throw this.error('Directive "output" can only be used within a "template" or "proto"');
			}

			this.startInlineDir('output');
			if (this.isSimpleOutput()) {
				this.save('__SNAKESKIN_RESULT__ += ' + this.prepareOutput(command, scan && scan[1]) + ';');
			}
		}
	}
);