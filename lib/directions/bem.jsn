/**!
 * @status stable
 * @version 1.0.0
 */

Snakeskin.addDirective(
	'setBEM',

	null,

	(command, commandLength, dir, params) => {
		dir
			.isDirectiveInBlock(params.name)
			.startInlineDir(params.name);

		var part = command.match(/([\s\S]*?),\s+([\s\S]*)/m);
		bem[part[1]] = (new Function('return {' +
			dir.pasteDangerBlocks(part[2]) + '}')
		)();
	}
);

Snakeskin.addDirective(
	'bem',

	null,

	(command, commandLength, dir, params) => {
		dir
			.isDirectiveInBlock(params.name)
			.startDir(params.name, {
				tag: /^\(/.test(command) ? /\(([\s\S]*?)\)/m.exec(command)[1] : null
			});

		var lastBEM = dir.structure.params;

		// Получаем параметры инициализации блока и врапим имя кавычками
		command = lastBEM.tag ? command.replace(/^[\s\S]*?\)([\s\S]*)/m, '$1') : command;
		var part = command.trim().split(',');

		var bemName = part[0];
		lastBEM.original = bem[bemName] && bem[bemName].tag;

		if (dir.isSimpleOutput()) {
			part[0] += '\'';
			command = part.join(',');

			dir.save(
				'__SNAKESKIN_RESULT__ += \'' +
					'<' + (lastBEM.tag || lastBEM.original || 'div') + ' class="i-block" data-params="{name: \\\'' +
					dir.replaceTplVars(command) +
				'}">\';'
			);
		}
	},

	(command, commandLength, dir) => {
		if (dir.isSimpleOutput()) {
			let lastBEM = dir.structure.params;
			dir.save('__SNAKESKIN_RESULT__ += \'</' + (lastBEM.tag || lastBEM.original || 'div') + '>\';');
		}
	}
);