/**!
 * @status stable
 * @version 1.0.0
 */

Snakeskin.addDirective(
	'setBEM',

	{
		placement: 'global'
	},

	function (command) {
		this.startInlineDir();
		var part = command.match(/(.*?),\s+(.*)/);

		bem[part[1]] = (new Function('return {' +
			this.pasteDangerBlocks(part[2]) +
		'}'))();
	}
);

Snakeskin.addDirective(
	'bem',

	{
		placement: 'template'
	},

	function (command) {
		this.startDir(null, {
			tag: /^\(/.test(command) ? /\((.*?)\)/.exec(command)[1] : null
		});

		if (this.isSimpleOutput()) {
			let lastBEM = this.structure.params;

			// Получаем параметры инициализации блока и врапим имя кавычками
			command = lastBEM.tag ? command.replace(/^.*?\)(.*)/, '$1') : command;
			let part = command.trim().split(',');

			let bemName = part[0];
			lastBEM.original = bem[bemName] && bem[bemName].tag;

			part[0] += '\'';
			command = part.join(',');

			this.save(
				'__SNAKESKIN_RESULT__ += \'' +
					'<' + (lastBEM.tag || lastBEM.original || 'div') + ' class="i-block" data-params="{name: \\\'' +
					this.replaceTplVars(command) +
				'}">\';'
			);
		}
	},

	function () {
		if (this.isSimpleOutput()) {
			let lastBEM = this.structure.params;
			this.save('__SNAKESKIN_RESULT__ += \'</' + (lastBEM.tag || lastBEM.original || 'div') + '>\';');
		}
	}
);