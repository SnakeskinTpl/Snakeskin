/**!
 * @status stable
 * @version 1.0.0
 */

// Короткая форма директивы end
Snakeskin.Replacers['/'] = (cmd) => cmd.replace(/^\//, 'end ');

/**
 * Директива end
 *
 * @param {string} command - текст команды
 *
 * @param {number} commandLength - длина команды
 * @param {!DirObj} dir - объект управления директивами
 *
 * @param {Object} adv - дополнительные параметры
 * @param {!Object} adv.info - информация о шаблоне (название файлы, узла и т.д.)
 */
Snakeskin.Directions['end'] = function (command, commandLength, dir, adv) {
	if (!dir.structure.parent) {
		throw dir.error('Invalid call "end", ' +
			dir.genErrorAdvInfo(adv.info)
		);
	}

	var obj = dir.structure;

	// Если в директиве end указано название закрываемой директивы,
	// то проверяем, чтобы оно совпадало с реально закрываемой директивой
	if (command && command !== obj.name) {
		throw dir.error('Invalid closing tag, expected: ' +
			obj.name +
			', declared: ' +
			command +
			', ' +
			dir.genErrorAdvInfo(adv.info)
		);
	}

	if (Snakeskin.strongDirs[obj.name]) {
		dir.strongDir = null;
	}

	if (dir.returnStrongDir && dir.returnStrongDir.child === obj.name) {
		dir.strongDir = dir.returnStrongDir.dir;
		dir.strongSpace = true;
		dir.returnStrongDir = null;
	}

	if (Snakeskin.Directions[obj.name + 'End']) {
		Snakeskin.Directions[obj.name + 'End'].apply(Snakeskin, arguments);

	} else if (!obj.isSys && dir.isSimpleOutput()) {
		dir.save('};');
	}

	dir.endDir();
};