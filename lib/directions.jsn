/**!
 * @status stable
 * @version 1.0.0
 */

/**
 * Добавить новую директиву в пространство имён шаблонизатора
 *
 * @param {string} name - название директивы
 * @param {Object} params - дополнительные параметры
 *
 * @param {?string=} [params.placement] - если true, то делается проверка,
 *     где именно размещена директива ('global', 'template', ...)
 *
 * @param {?boolean=} [params.sys=false] - если true, то директива считается системной
 *
 * @param {Object} [params.replacers] - объект коротких сокращений директивы
 * @param {Object} [params.strongDirs] - объект директив, которые могут быть вложены в исходную
 *
 * @param {function(this:DirObj, string, number)} constr - конструктор директивы
 * @param {?function(this:DirObj, string, number)=} opt_end - окончание директивы
 */
Snakeskin.addDirective = function (name, params, constr, opt_end) {
	params = params || {};
	sysDirs[name] = !!params.sys;

	if (params.replacers) {
		let repls = params.replacers;

		for (let key in repls) {
			if (!repls.hasOwnProperty(key)) {
				continue;
			}

			replacers[key] = repls[key];
		}
	}

	strongDirs[name] = params.strongDirs;
	Snakeskin.Directions[name] = function (dir, command, commandLength) {
		switch (params.placement) {
			case 'template': {
				if (!dir.structure.parent) {
					throw dir.error('Directive "' + name + '" can only be used within a "template" or "proto"');
				}
			} break;

			case 'global': {
				if (dir.structure.parent) {
					throw dir.error('Directive "' + name + '" can be used only within the global space');
				}
			} break;

			default: {
				if (params.placement) {
					if (dir.hasParent(params.placement)) {
						throw dir.error('Directive "' + name + '" can be used only within a "' + params.placement + '"');
					}
				}
			}
		}

		dir.name = name;

		if (dir.strongDir && strongDirs[dir.strongDir][name]) {
			dir.returnStrongDir = {
				child: name,
				dir: dir.strongDir
			};

			dir.strongDir = null;
			dir.strongSpace = false;
		}

		constr.call(dir, command, commandLength);

		if (dir.inlineDir === true) {
			dir.inlineDir = null;
			dir.structure = dir.structure.parent;
		}

		if (strongDirs[name]) {
			dir.strongDir = name;
			dir.strongSpace = true;
		}
	};

	Snakeskin.Directions[name + 'End'] = opt_end;
};