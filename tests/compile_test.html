<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Test: Snakeskin.compile</title>
		<link type="text/css" rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.13.0.css" />

		<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
		<script type="text/javascript" src="http://code.jquery.com/qunit/qunit-1.13.0.js"></script>
		<script type="text/javascript" src="../build/snakeskin.min.js"></script>
	</head>

	<body>
		<h1 id="qunit-header">Test: Snakeskin.compile</h1>
		<h2 id="qunit-banner"></h2>
		<div id="qunit-testrunner-toolbar"></div>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		<div id="test"></div>

		<script type="text/x-snakeskin-template" id="template">
			{template first(name = 'world')}
				{text = 'Hello'}
				<h1>{text} {name}!</h1>
			{end}
		<script>

		<script type="text/x-snakeskin-template" id="templates">
			{template tpl.first(name = 'world')}
				{text = 'Hello'}
				<h1>{text} {name}!</h1>
			{end}

			{template second(name = 'world', lastName)}
				{text = 'Hello'}
				<h1>{text} {name + lastName}!</h1>
			{end}

			{template withWith(obj)}
				{with obj.child}
					{name}
					{with child}
						 {name}
					{end}
				{end}
			{end}

			{template withIf(a)}
				{if a === 4}
					OK
				{elseIf a === 3}
					FAIL
				{else}
					WIN
				{end}
			{end}

			{template forEachTest(a)}
				{forEach a => el}
					{el}
				{end}
			{end}

			{template deepForEach(a)}
				{forEach a => el}
					{forEach el => el}
						{el}
					{end}
				{end}
			{end}

			{template base(a = 1, b)}
				{title = 'foo'}
				{proto test}
					{proto start}
						OK
					{end}

					READY {apply start} ?
				{end}

				<!doctype html>
				<html>
					{block head}
						<head>
							{block title}
								<title>{title + (a + b)}</title>
							{end}
						</head>
					{end}
					{block footer}
						{apply test}
					{end}
				</html>
			{end}

			{template child(a = 3) extends base}
				{title = 'foo2'}
				{b = 'foo'}
				{e = {a: 1, b: [1, 2, 3]}}

				{proto start}
					NO
				{end}

				{block head}
					{title + a}
				{end}

				{block footer}
					{block end}
						{b}
					{end}

					{apply test}
				{end}

				{block next}
					121
				{end}
			{end}

			{template withFilter()}
				{b = '"onclick="\'alert(1)\'"'}
				<a href="{b}"></a>
			{end}

			{template withoutFilter()}
				{b = '"onclick="\'alert(1)\'"'}
				<a href="{b|!html}"></a>
			{end}

			{template withCData()}
				{cdata}
					{template withFilter()}
						{b = '"onclick="\'alert(1)\'"'}
						<a href="{b}"></a>
					{end}
				{end cdata}

				{text = 'Hello'}
				<h1>{text}{cdata}
					{a}
				{/cdata}!</h1>
			{end}

			{global = 1}
			{setBEM my, tag: 'head'}
			{template bemTestParent()}
				{a = 'foo   '}
				{proto a}
					{block e}
						{bem (span) my, val: 1, next: '${a|ucfirst|trim}'}{end}
						{bem my, val: 1, next: '${a|ucfirst|trim}'}{end}
					{end}
				{end}
			{end}

			{global = 2}
			{global = 3}

			{template bemTest() extends bemTestParent}
				{block aa}
					{apply a}
					{@global}
				{end}
			{end}

			{template testEscape(a = /1/, b = '2/2/\\\'')}
				{c = (/1[2]\/\\/)}
				{3 / 3}
			{/template}

			{template testComment(/* as */)}
				///123
				/*sd*/
				{a =
					///1
					2
				}
				{e = /"'/}
				{a}
				{b = /* 2 */ 3}
				{b}
			{/template}

			{template testCycles(i = 0)}
				{for var j = 0; j < 3; j++}
					{j}
				{end}

				{while i++ < 3}
					{i}
				{end}

				{repeat}
					{i}
				{until i--}
			{end template}

			{template testConst(a)}
				{1 == 2 ? (function () { var a = 1; return a; })() : 2}
				{1 === 1}
				{b = {}}
				{b.foo = 1}
				{b['foo2'] = 2}
				{b.foo + b.foo2}

				{proto foo}
					{aa = 2}
					{aa}
				{end}

				{apply foo}
				{apply foo}
			{end}

			{template superTestConst()}
				{proto a}
					{foo = 1}
				{end}
				{apply a}
			{end}

			{template childTestConst() extends superTestConst}
				{proto a}
					{foo = 2}
					{foo}
				{end}
			{end}

			{template superTestConst2()}
				{proto a}
					{a = 1}
				{end}
				{apply a}
			{/template}

			{template childTestConst2() extends superTestConst2}
				{proto a}
					{a = 2}
					{proto e}
						{j = 1}
						{j}
					{end}
					{apply e}
				{end}
				{apply a}
			{/template}

			{a = 10}
			{template newTestWith()}
				{var foo = {
					child: {a: 1, child: {name: 'test'}},
					a: 2
				}}
				{a = 2}
				{with foo}
					{with child}
						{with child}
							{proto e}
								{(name|remove @String('s')) + (#a + #2a + @a + @@a) |ucfirst |remove @String('e')}
							{end}
						{end}
					{end}
				{end with}

				{apply e}
			{/template}

			{template newDataTest()}
				{a = 1}
				{{
					{name: "${a + @a /* 123 */ + ('foo'|ucfirst) + '{}'}"}
				}}
			{/template}
		</script>

		<script type="text/javascript">
			var block = document.getElementById('templates');
			Snakeskin.compile(block);

			test('Snakeskin.compile', function () {
				equal(first(), '<h1>Hello world!</h1>', 'Параметр по умолчанию + переменная');
				equal(first('Koba'), '<h1>Hello Koba!</h1>', 'Параметр + переменная');
				equal(tpl.first('Koba'), '<h1>Hello Koba!</h1>', 'Параметр + переменная (вызов из пространства имён)');
				equal(second('Koba', 'Cool'), '<h1>Hello KobaCool!</h1>', 'Два параметра + переменная + выражение');
				equal(withWith({
					child: {
						name: 'Koba',
						child: {
							name: 'none'
						}
					}
				}), 'Koba none', 'С использованием with');
				equal(withIf(4), 'OK', 'Проверка if');
				equal(withIf(3), 'FAIL', 'Проверка elseIf');
				equal(withIf(33), 'WIN', 'Проверка else');
				equal(forEachTest([1, 2, 3]), '123', 'forEach');
				equal(deepForEach([[1, 2, 3]]), '123', 'forEach forEach');
				equal(base(2, 1), '<!doctype html><html><head><title>foo3</title></head>READY OK ?</html>', 'Базовый блок наследования');
				equal(child(), '<!doctype html><html>foo23fooREADY NO ?</html>121', 'Проверка наследования');
				equal(withFilter(), '<a href=\"&quot;onclick=&quot;&#39;alert(1)&#39;&quot;\"></a>', 'Работа с фильтрами');
				equal(withoutFilter(), '<a href=""onclick="\'alert(1)\'""></a>', 'Работа с фильтрами (без экранирования)');
				equal(withCData(), '\n					{template withFilter()}\n						{b = &#39;\"onclick=\"&#39;alert(1)&#39;\"&#39;}\n						<a href=\"{b}\"></a>\n					{end}\n				<h1>Hello\n					{a}\n				!</h1>', 'Использование cdata областей');
				equal(bemTest(), '<span class=\"i-block\" data-params=\"{name: \'my\', val: 1, next: \'Foo\'}\"></span><head class=\"i-block\" data-params=\"{name: \'my\', val: 1, next: \'Foo\'}\"></head>3', 'myFireBEM');
				equal(testEscape(), '1', 'Проверка экранирования в директивах и работы / окончаний');
				equal(testComment(), '23', 'Проверка работы комментариев');
				equal(testCycles(), '01212343210', 'Проверка работы циклов');
				equal(testConst(), '210322', 'Проверка работы констант');
				equal(childTestConst(), '2', 'Проверка работы констант при наследовании');
				equal(childTestConst2(), '1', 'Проверка работы констант при наследовании #2');
				equal(newTestWith(), 'Tt15', 'Проверка работы scope');
				equal(newDataTest(), '{{name: "11Foo{}"}}', 'Проверка прокидывания переменных в data');
			});
		</script>
	</body>
</html>