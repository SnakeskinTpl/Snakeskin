<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Test: Snakeskin.compile</title>
		<link type="text/css" rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.11.0.css" />
		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<script type="text/javascript" src="http://code.jquery.com/qunit/qunit-1.11.0.js"></script>
		<script type="text/javascript" src="../snakeskin.min.js"></script>
	</head>
	<body>
		<h1 id="qunit-header">Test: Snakeskin.compile</h1>
		<h2 id="qunit-banner"></h2>
		<div id="qunit-testrunner-toolbar"></div>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		<div id="test"></div>

		<script type="text/x-snakeskin-template" id="templates">
			{template first(name = 'world')}
				{text = 'Hello'}
				<h1>{text} {name}!</h1>
			{end}

			{template tpl.first(name = 'world')}
				{text = 'Hello'}
				<h1>{text} {name}!</h1>
			{end}

			{template second(name = 'world', lastName)}
				{text = 'Hello'}
				<h1>{text} {name + lastName}!</h1>
			{end}

			{template withWith(obj)}
				{with obj.child}
					{name}
					{with child}
						 {name}
					{end}
				{end}
			{end}

			{template withIf(a)}
				{if a === 4}
					OK
				{elseIf a === 3}
					FAIL
				{else}
					WIN
				{end}
			{end}

			{template forEachTest(a)}
				{forEach a => el}
					{el}
				{end}
			{end}

			{template deepForEach(a)}
				{forEach a => el}
					{forEach el => el}
						{el}
					{end}
				{end}
			{end}

			{template base(a = 1, b)}
				{title = 'foo'}
				{proto test}
					{proto start}
						OK
					{end}

					READY {apply start} ?
				{end}

				<!doctype html>
				<html>
					{block head}
						<head>
							{block title}
								<title>{title + (a + b)}</title>
							{end}
						</head>
					{end}
					{block footer}
						{apply test}
					{end}
				</html>
			{end}

			{template child(a = 3) extends base}
				{title = 'foo2'}
				{b = 'foo'}
				{e = {a: 1, b: [1, 2, 3]}}

				{proto start}
					NO
				{end}

				{block head}
					{title + a}
				{end}

				{block footer}
					{block end}
						{b}
					{end}

					{apply test}
				{end}

				{block next}
					121
				{end}
			{end}

			{template withFilter()}
				{b = '"onclick="\'alert(1)\'"'}
				<a href="{b}"></a>
			{end}

			{template withoutFilter()}
				{b = '"onclick="\'alert(1)\'"'}
				<a href="{b|!html}"></a>
			{end}

			{template withCData()}
				{cdata}
					{template withFilter()}
						{b = '"onclick="\'alert(1)\'"'}
						<a href="{b}"></a>
					{end}
				{end cdata}

				{text = 'Hello'}
				<h1>{text}{cdata}
					{a}
				{end cdata}!</h1>
			{end}

			{global = 1}
			{setBEM my, tag: 'head'}
			{template bemTestParent()}
				{a = 'foo   '}
				{proto a}
					{block e}
						{bem (span) my, val: 1, next: '${a|ucfirst|trim}'}{end}
						{bem my, val: 1, next: '${a|ucfirst|trim}'}{end}
					{end}
				{end}
			{end}

			{global = 2}
			{global = 3}

			{template bemTest() extends bemTestParent}
				{block aa}
					{apply a}
					{global}
				{end}
			{end}
		</script>

		<script type="text/javascript">
			var block = document.getElementById('templates');
			Snakeskin.compile(block)

			test('Snakeskin.compile', function () {
				equal(first(), '<h1>Hello world!</h1>', 'Параметр по умолчанию + переменная');
				equal(first('Koba'), '<h1>Hello Koba!</h1>', 'Параметр + переменная');
				equal(tpl.first('Koba'), '<h1>Hello Koba!</h1>', 'Параметр + переменная (вызов из пространства имён)');
				equal(second('Koba', 'Cool'), '<h1>Hello KobaCool!</h1>', 'Два параметра + переменная + выражение');
				equal(withWith({
					child: {
						name: 'Koba',
						child: {
							name: 'none'
						}
					}
				}), 'Koba none', 'С использованием with');
				equal(withIf(4), 'OK', 'Проверка if');
				equal(withIf(3), 'FAIL', 'Проверка elseIf');
				equal(withIf(33), 'WIN', 'Проверка else');
				equal(forEachTest([1, 2, 3]), '123', 'forEach');
				equal(deepForEach([[1, 2, 3]]), '123', 'forEach forEach');
				equal(base(2, 1), '<!doctype html><html><head><title>foo3</title></head>READY OK ?</html>', 'Базовый блок наследования');
				equal(child(), '<!doctype html><html>foo23fooREADY NO ?</html>121', 'Проверка наследования');
				equal(withFilter(), '<a href=\"&quot;onclick=&quot;&#39;alert(1)&#39;&quot;\"></a>', 'Работа с фильтрами');
				equal(withoutFilter(), '<a href=""onclick="\'alert(1)\'""></a>', 'Работа с фильтрами (без экранирования)');
				equal(withCData(), '\n					{template withFilter()}\n						{b = &#39;\"onclick=\"&#39;alert(1)&#39;\"&#39;}\n						<a href=\"{b}\"></a>\n					{end}\n				<h1>Hello\n					{a}\n				!</h1>', 'Использование cdata областей');
				equal(bemTest(), '<span class=\"i-bem\" data-params=\"{name: \'my\', val: 1, next: \'Foo\'}\"></span><head class=\"i-bem\" data-params=\"{name: \'my\', val: 1, next: \'Foo\'}\"></head>3', 'myFireBEM');
			});
		</script>
	</body>
</html>